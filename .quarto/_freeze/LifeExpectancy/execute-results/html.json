{
  "hash": "0a3d6253f1094985638680a56764c248",
  "result": {
    "markdown": "---\ntitle: \"LifeExpectancy\"\nflexdashboard::flex_dashboard:\n    runtime: shiny\nformat:\n  html:\n    grid: \n      body-width: 1400px\n---\n\n\n## \n\n## Life Expectancy\n\nEl siguiente código toma un [dataset](https://github.com/rfordatascience/tidytuesday/blob/master/data/2023/2023-12-05/readme.md \"TidyTuesday Life Expectancy\") provisto por [Tidy Tuesday](https://github.com/rfordatascience/tidytuesday/tree/master \"Tidy Tuesday Github\") que brinda información sobre la expectativa de vida anual de cada pais e intenta responder las siguientes preguntas:\n\n1- Cuáles son los 3 paises que en promedio tuvieron mayor/menor expectativa de vida cada año?\n\n2- Cuáles son los paises que lideraron en cada año con mayor/menor expectativa de vida?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Instalar y cargar las librerias\n# install.packages(c(\"tidytuesdayR\", \"DBI\", \"RSQLite\",\"tidyverse\",\"summarytools\",\"datos\",\"shiny\"))\nlibrary(tidytuesdayR)\nlibrary(DBI)\nlibrary(RSQLite)\nlibrary(summarytools)\nlibrary(tidyverse)\nlibrary(datos)\nlibrary(shiny)\nlibrary(tinytex)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Descargar los datasets\ntuesdata <- tidytuesdayR::tt_load(\"2023-12-05\")\nlife_expectancy <- tuesdata$life_expectancy\nlife_expectancy_different_ages <- tuesdata$life_expectancy_different_ages\n# life_expectancy_female_male <- tuesdata$life_expectancy_female_male \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Crear una conexión ficticia a una base de datos ficticia\ncon <- dbConnect(RSQLite::SQLite(), dbname = \":memory:\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Crear tablas e insertar los datasets\ndbWriteTable(con, \"life\", life_expectancy)\ndbWriteTable(con, \"life_ages\", life_expectancy_different_ages)\n# dbWriteTable(con, \"life_sex\", life_expectancy_female_male)\n```\n:::\n\n\n------------------------------------------------------------------------\n\n\n{{< page-break >}}\n\n\n\n## Expectativa de vida por continente\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Consultar datos desde la tabla life\nContinents <- dbGetQuery(con, \"\n                         SELECT * \n                         FROM life \n                         WHERE Entity='Americas' \n                         OR Entity='Africa'  \n                         OR Entity='Asia'  \n                         OR Entity='Europe' \n                         OR Entity='Oceania' \n                         OR Entity='World'\n                         \")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Graficar las expectativas de vida por continente\nggplot(Continents, aes(x = Year, y = LifeExpectancy, color = Entity, label = Entity)) +\n  geom_line() +\n  geom_point() +\n  labs(title = \"Evolución de la Expectativa de Vida por continente\",\n       x = \"Año\",\n       y = \"Expectativa de Vida\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](LifeExpectancy_files/figure-html/grafico_continentes-1.png){width=672}\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n\n{{< page=break >}}\n\n\n\n## Expectativa de vida por nivel de ingresos\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Consultar datos desde la tabla life\nIncome <- dbGetQuery(con, \"\n                         SELECT * \n                         FROM life \n                         WHERE Entity='Low-income countries' \n                         OR Entity='Lower-middle-income countries'  \n                         OR Entity='Middle-income countries'  \n                         OR Entity='Upper-middle-income countries' \n                         OR Entity='High-income countries' \n                         \")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Graficar las expectativas de vida por nivel de ingresos\nggplot(Income, aes(x = Year, y = LifeExpectancy, color = Entity, label = Entity)) +\n  geom_line() +\n  geom_point() +\n  labs(title = \"Evolución de la Expectativa de Vida por nivel de ingresos\",\n       x = \"Año\",\n       y = \"Expectativa de Vida\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](LifeExpectancy_files/figure-html/grafico_ingresos-1.png){width=672}\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n\n{{< page-break >}}\n\n\n\n## Expectativa de vida por nivel de desarrollo\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Consultar datos desde la tabla life\nDevelopment <- dbGetQuery(con, \"\n                         SELECT * \n                         FROM life \n                         WHERE Entity='Less developed regions' \n                         OR Entity='Less developed regions, excluding China'  \n                         OR Entity='Less developed regions, excluding least developed countries'  \n                         OR Entity='More developed regions' \n                         OR Entity='Small Island Developing States (SIDS)' \n                         \")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Graficar las expectativas de vida por nivel de ingresos\nggplot(Development, aes(x = Year, y = LifeExpectancy, color = Entity, label = Entity)) +\n  geom_line() +\n  geom_point() +\n  labs(title = \"Evolución de la Expectativa de Vida por nivel de desarrollo\",\n       x = \"Año\",\n       y = \"Expectativa de Vida\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](LifeExpectancy_files/figure-html/grafico_desarrollo-1.png){width=672}\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n\n{{< page-break >}}\n\n\n\n## Paises extremos\n\nPaises extremos son los 3 paises que en promedio tuvieron mayor/menor expectativa de vida cada año.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filtrar datos a partir de 1950 hasta 2019\ndata <- life_expectancy %>% filter(Year >= 1950 & Year <= 2019,\n                                    !grepl(\"develop\", Entity, ignore.case = TRUE))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndbWriteTable(con, \"data\", data)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Consulta para obtener los 3 países con mayor LifeExpectancy en promedio\nquery_top_countries <- \"\n  SELECT Entity, AVG(LifeExpectancy) AS AvgLifeExpectancy\n  FROM data\n  GROUP BY Entity\n  ORDER BY AvgLifeExpectancy DESC\n  LIMIT 3\n\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Consulta para obtener los 3 países con menor LifeExpectancy en promedio\nquery_bottom_countries <- \"\n  SELECT Entity, AVG(LifeExpectancy) AS AvgLifeExpectancy\n  FROM data\n  GROUP BY Entity\n  ORDER BY AvgLifeExpectancy ASC\n  LIMIT 3\n\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Ejecutar las consultas y guardar los resultados en dataframes\ntop_countries <- dbGetQuery(con, query_top_countries)\nbottom_countries <- dbGetQuery(con, query_bottom_countries)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Mostrar los resultados\nprint(\"Países con mayor LifeExpectancy en promedio:\")\nprint(top_countries)\n\nprint(\"Países con menor LifeExpectancy en promedio:\")\nprint(bottom_countries)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Consultar datos desde la tabla life\nExtremos <- dbGetQuery(con, \"SELECT * FROM life WHERE Entity='Monaco' OR Entity='Andorra'  OR Entity='San Marino'  OR Entity='South Sudan' OR Entity='Mali' OR Entity='Sierra Leone'\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nextremos <- Extremos %>%\n  filter(Year >= 1950)\n# Graficar las expectativas de vida por paises extremos\nggplot(extremos, aes(x = Year, y = LifeExpectancy, color = Entity, label = Entity)) +\n  geom_line() +\n  geom_point() +\n  labs(title = \"Evolución de la Expectativa de Vida por paises extremos\",\n       x = \"Año\",\n       y = \"Expectativa de Vida\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](LifeExpectancy_files/figure-html/extremos-1.png){width=672}\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n\n{{< page-break >}}\n\n\n\n## Expectativa de vida segun edad\n\nA continuacion se compara la expectativa de vida al nacer versus la expectativa de vida al tener 80 años.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndbWriteTable(con, \"extremos\", extremos)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Realizar el JOIN\nresult_join <- dbGetQuery(con, \"\n  SELECT LE.*, LDA.LifeExpectancy80\n  FROM extremos LE\n  INNER JOIN life_ages LDA\n  ON LE.Entity = LDA.Entity AND LE.Year = LDA.Year\n\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nresult_window <- dbGetQuery(con, \"\n  SELECT Entity, Year, LifeExpectancy, LifeExpectancy80,\n         LifeExpectancy80 - LifeExpectancy AS DiffLifeExpectancy\n  FROM (\n    SELECT LE.Entity, LE.Year, LE.LifeExpectancy, LDA.LifeExpectancy80,\n           ROW_NUMBER() OVER (PARTITION BY LE.Entity, LE.Year) AS row_num\n    FROM extremos LE\n    INNER JOIN life_ages LDA\n    ON LE.Entity = LDA.Entity AND LE.Year = LDA.Year\n  ) AS subquery\n  WHERE row_num = 1\n\")\n\n# print(result_window)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Graficar las expectativas de vida srgun edad por paises extremos\nggplot(result_window, aes(x = Year, y = DiffLifeExpectancy, color = Entity, label = Entity)) +\n  geom_line() +\n  geom_point() +\n  labs(title = \"Diferencia de la Expectativa de Vida segun edad por paises extremos\",\n       x = \"Año\",\n       y = \"Expectativa de Vida\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](LifeExpectancy_files/figure-html/delta-1.png){width=672}\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n\n{{< page-break >}}\n\n\n\n## Mejor performance\n\nCual fue el pais que tuvo mejor evolucion de su expectativa de vida?\n\n1.  Common Table Expression (CTE) - RankedLifeExpectancy se obtienen los siguientes datos de data:\n\n    1.  Mediante la funcion de ventana LAG() se obtiene PrevYearLifeExpectancy, particionando los datos por Entity.\n\n    2.  La diferencia entre el año actual y el anterior es ChangeInLifeExpectancy.\n\n2.  Consulta principal: Selecciona el MaxIncreaseInLifeExpectancy de RankedLifeExpectancy.\n\n3.  Ejecución y resultado: Se obtien un ranking de los paises con mayor crecimiento de expectativa de vida en su año record.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbest_year <- dbGetQuery(con, \"\nWITH RankedLifeExpectancy AS (\n  SELECT\n    Entity,\n    Year,\n    LifeExpectancy,\n    LAG(LifeExpectancy) OVER (PARTITION BY Entity ORDER BY Year) AS PrevYearLifeExpectancy,\n    LifeExpectancy - LAG(LifeExpectancy) OVER (PARTITION BY Entity ORDER BY Year) AS ChangeInLifeExpectancy\n  FROM\n    data\n)\n\nSELECT\n  Entity, \n  Year as BestYear,\n  MAX(ChangeInLifeExpectancy) AS MaxIncrease\nFROM\n  RankedLifeExpectancy\nGROUP BY\n  Entity\nORDER BY\n  MaxIncrease DESC\nLIMIT 10;\n\")\n\nprint(best_year)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                   Entity BestYear MaxIncrease\n1                  Rwanda     1995     25.8707\n2                 Lebanon     1977     25.5465\n3             South Sudan     1999     24.8376\n4              Bangladesh     1972     23.5946\n5                 Somalia     1993     23.3369\n6               Palestine     1974     23.2408\n7                Cambodia     1977     16.8974\n8  Bosnia and Herzegovina     1994     15.6905\n9                   Haiti     2011     15.6042\n10                 Cyprus     1975     15.2879\n```\n:::\n:::\n",
    "supporting": [
      "LifeExpectancy_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}